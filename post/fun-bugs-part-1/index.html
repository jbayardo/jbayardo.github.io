<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Fun Bugs: Episode I | Julian through the Lens</title>
<meta property='og:title' content='Fun Bugs: Episode I - Julian through the Lens'><meta property='og:description' content='Introduction I&rsquo;ve been meaning to get started on a series talking about the kind of bugs we find in production on the CloudBuild Cache. For a little bit of context, our team runs over 40k machines across the US, with over 85 PB of total storage capacity, and serve as a caching layer for lots of things: source code, NuGet packages, build artifacts, etc etc. We basically provide a P2P cache made specifically for builds within CloudBuild, though the current implementation is nothing like the paper.'><meta property='og:url' content='https://julian.bayardo.info/post/fun-bugs-part-1/'><meta property='og:site_name' content='Julian through the Lens'><meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/fdbc036a46f3c0903c7e39459db599c0?s=256'><meta property='article:section' content='Post'><meta property='article:tag' content='bugs'><meta property='article:published_time' content='2020-09-14T01:41:00-07:00'><meta property='article:modified_time' content='2020-09-14T01:41:00-07:00'><meta name=twitter:card content='summary'><meta name=twitter:site content='@BayardoJulian'><meta name=twitter:creator content='@BayardoJulian'><link rel=alternate type=application/rss+xml title="Julian through the Lens" href=/post/index.xml><link rel=stylesheet href=/css/style.min.572ee845ad8da3c5d2a0a9e157da4b896325fafa6ff5b9b18ae122044000e00e.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://julian.bayardo.info/post/fun-bugs-part-1/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><header class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://julian.bayardo.info/><h1 id=nav-heading class="title is-4">Julian through the Lens</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/jbayardo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</i></span></a><a class=level-item aria-label=email href=mailto:julian@bayardo.info target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/jbayardo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922H1.468748v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-left><a class=nav-item href=/search><h2 class="title is-5">Search</h2></a><a class=nav-item href=/series><h2 class="title is-5">Series</h2></a><a class=nav-item href=/tags><h2 class="title is-5">Tags</h2></a></div><div class=nav-right><a class=nav-item href=/about><h2 class="title is-5">About me</h2></a><a class=nav-item href=/disclaimer><h2 class="title is-5">Disclaimer</h2></a></div></nav></div><script src=/js/navicon-shift.min.c7620c1a856fc9aead68a6e5fa7d6a739ac88b0ef5eb6834fb6dacf7dc82adc3.js integrity="sha256-x2IMGoVvya6taKbl+n1qc5rIiw7162g0+22s99yCrcM=" crossorigin=anonymous async defer></script></header><section class="section article-section"><article class=article data-pagefind-body><div class=article-container><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="tag is-6 is-link" href=/tags/bugs data-pagefind-filter=tag><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
bugs</a></div><h2 class="subtitle is-6" data-pagefind-meta=date>September 14, 2020</h2><h1 class=title data-pagefind-meta=title>Fun Bugs: Episode I</h1><div class="content article"><nav class="table-of-contents boxed"><h2 class=title>Table of Contents</h2><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#the-disposal-race-condition>The Disposal Race Condition</a></li></ol></nav></nav><h1 id=introduction>Introduction
<a href=#introduction style=float:right;border-bottom:0><svg width="16" height="16" viewBox="0 0 8 8"><path d="M5.88.03c-.18.01-.36.03-.53.09-.27.1-.53.25-.75.47a.5.5.0 10.69.69c.11-.11.24-.17.38-.22.35-.12.78-.07 1.06.22.39.39.39 1.04.0 1.44l-1.5 1.5c-.44.44-.8.48-1.06.47-.26-.01-.41-.13-.41-.13a.5.5.0 10-.5.88s.34.22.84.25 1.2-.16 1.81-.78l1.5-1.5c.78-.78.78-2.04.0-2.81-.28-.28-.61-.45-.97-.53-.18-.04-.38-.04-.56-.03zm-2 2.31c-.5-.02-1.19.15-1.78.75L.6 4.59c-.78.78-.78 2.04.0 2.81.56.56 1.36.72 2.06.47.27-.1.53-.25.75-.47a.5.5.0 10-.69-.69c-.11.11-.24.17-.38.22-.35.12-.78.07-1.06-.22-.39-.39-.39-1.04.0-1.44l1.5-1.5c.4-.4.75-.45 1.03-.44.28.01.47.09.47.09a.5.5.0 10.44-.88s-.34-.2-.84-.22z"/></svg></a></h1><p>I&rsquo;ve been meaning to get started on a series talking about the kind of bugs we find in production on the CloudBuild Cache. For a little bit of context, our team runs over 40k machines across the US, with over 85 PB of total storage capacity, and serve as a caching layer for lots of things: source code, NuGet packages, build artifacts, etc etc. We basically provide a P2P cache made specifically for builds within <a href=https://www.microsoft.com/en-us/research/publication/cloudbuild-microsofts-distributed-and-caching-build-service/>CloudBuild</a>, though the current implementation is nothing like the paper.</p><p>The scale and sheer number of operations we run ends up causing every nook and cranny of the code to be run in parallel at different times, which usually leads to <em>really</em> interesting bugs. The attempt of this &ldquo;series&rdquo; will be to show those to others, so that they may hopefully get a laugh, maybe even learn something (and also so I get more fluent at writing).</p><figure><img src=/post/fun-bugs-part-1/this-is-fine.jpeg alt="This is fine" style=max-width:500px><figcaption>A day on the job</figcaption></figure><p>For this first one, I&rsquo;m choosing an entertaining one we found last week. Admittedly, it&rsquo;s not the craziest thing ever, but it&rsquo;s still a fun one. In any case, enjoy!.</p><h1 id=the-disposal-race-condition>The Disposal Race Condition
<a href=#the-disposal-race-condition style=float:right;border-bottom:0><svg width="16" height="16" viewBox="0 0 8 8"><path d="M5.88.03c-.18.01-.36.03-.53.09-.27.1-.53.25-.75.47a.5.5.0 10.69.69c.11-.11.24-.17.38-.22.35-.12.78-.07 1.06.22.39.39.39 1.04.0 1.44l-1.5 1.5c-.44.44-.8.48-1.06.47-.26-.01-.41-.13-.41-.13a.5.5.0 10-.5.88s.34.22.84.25 1.2-.16 1.81-.78l1.5-1.5c.78-.78.78-2.04.0-2.81-.28-.28-.61-.45-.97-.53-.18-.04-.38-.04-.56-.03zm-2 2.31c-.5-.02-1.19.15-1.78.75L.6 4.59c-.78.78-.78 2.04.0 2.81.56.56 1.36.72 2.06.47.27-.1.53-.25.75-.47a.5.5.0 10-.69-.69c-.11.11-.24.17-.38.22-.35.12-.78.07-1.06-.22-.39-.39-.39-1.04.0-1.44l1.5-1.5c.4-.4.75-.45 1.03-.44.28.01.47.09.47.09a.5.5.0 10.44-.88s-.34-.2-.84-.22z"/></svg></a></h1><p>We use a Redis cluster as a low-bandwidth fast path for some of our data. This Redis instance is rather crucial, because not being able to fetch data from it means we have to wait for data to sync via the high-bandwidth slow path (which may take up to 5 minutes, versus the few milliseconds it takes to talk with Redis). To communicate with Redis, we use the marvelous <a href=https://github.com/StackExchange/StackExchange.Redis><code>StackExchange.Redis</code></a>&nbsp;<img src=/img/logos/github.svg alt="Site Logo" style=height:1em;vertical-align:middle;margin-right:5px> client.</p><p>The way you are supposed to use the library looks something like this:</p><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#719e07>using</span> StackExchange.Redis;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#586e75>// This is a cache for connections to the Redis cluster, meant to be stored and</span>
</span></span><span style=display:flex><span><span style=color:#586e75>// reused</span>
</span></span><span style=display:flex><span>ConnectionMultiplexer redis = ConnectionMultiplexer.Connect(<span style=color:#2aa198>&#34;localhost&#34;</span>); 
</span></span><span style=display:flex><span><span style=color:#586e75>// Get a connection</span>
</span></span><span style=display:flex><span>IDatabase db = redis.GetDatabase(); 
</span></span><span style=display:flex><span>... <span style=color:#586e75>// Do your thing with the connection</span>
</span></span><span style=display:flex><span>redis.Dispose(); <span style=color:#586e75>// Shut the cache down!</span>
</span></span></code></pre></td></tr></table></div></div><p>The problem is that sometimes this <code>ConnectionMultiplexer</code> starts acting up, and the instances it returns end up being unusable. We tried hunting down exactly what was going on, but it&rsquo;s relatively hard to just catch a machine while it&rsquo;s happening, because it often gets solved out of nowhere after a few minutes of wreaking havoc.</p><p>Not having a connection to Redis for us can mean a failed build, or worse, multiple failed builds (and we strive to keep a 99.9% build success rate, so we really can&rsquo;t afford those!). Since the connection to Redis is critical for us, we decided to implement 2 mechanisms:</p><ol><li>If we start seeing the error signatures that have empirically correlated in the past with a broken <code>ConnectionMultiplexer</code>, recreate it after some number of failures.</li><li>After re-creating more than X times in a short period of time, just force the service to restart.</li></ol><p>Essentially, this:</p><figure><img src=/post/fun-bugs-part-1/it-crowd.jpg alt="Hello, IT. Have you tried turning it off and on again?" style=max-width:500px><figcaption>Our bug-crushing strategy</figcaption></figure><p>This &ldquo;worked&rdquo;: we saw those errors stop happening; service restarts were relatively low (which meant that mechanism (1) was doing its job), and we were all happy. Alas, this was not to last!.</p><p>Out of the sudden, we started seeing a lot of <code>ObjectDisposedException</code> in places we were using the <code>ConnectionMultiplexer</code> instance. Enough experience with race conditions made us naturally wary of our &ldquo;innovative&rdquo; mitigation strategy. Turns out, this code fragment is essentially all you need to understand what&rsquo;s going wrong:</p><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>async</span> Task&lt;IDatabase&gt; GetDatabase(...) {
</span></span><span style=display:flex><span>  <span style=color:#719e07>if</span> (_resetMultiplexerCts.IsCancellationRequested) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>using</span> (<span style=color:#719e07>await</span> _mutex.WaitAsync()) {
</span></span><span style=display:flex><span>      <span style=color:#719e07>if</span> (_resetMultiplexerCts.IsCancellationRequested) {
</span></span><span style=display:flex><span>        _resetMultiplexerCts = <span style=color:#719e07>new</span> CancellationTokenSource();
</span></span><span style=display:flex><span>        <span style=color:#719e07>await</span> CloseConnectionMultiplexer(_connectionMultiplexer);
</span></span><span style=display:flex><span>        _connectionMultiplexer = <span style=color:#719e07>await</span> CreateConnectionMultiplexer();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>In our code, we&rsquo;d call <code>GetDatabase()</code> to fetch pooled the connection to Redis. When the need arose to reset the <code>ConnectionMultiplexer</code> instances, we basically did it by just adding a <code>CancellationTokenSource</code>:</p><ul><li>Whenever an operation finds that the current instance is broken, it calls <code>_resetMultiplexerCts.Cancel()</code></li><li>Any new operation that needs to use the multiplexer would realize this (as per the code above), and re-create it before moving on.</li></ul><p>The pattern on lines 2-4 is a <a href=https://en.wikipedia.org/wiki/Double-checked_locking>double-checked lock</a>&nbsp;<img src=/img/logos/wikipedia.svg alt="Site Logo" style=height:1em;vertical-align:middle;margin-right:5px>. The intention is that only the first operation that realizes the multiplexer is broken does the reset. All operations that come after will wait for it to complete before actually attempting to use it.</p><p>The big issue here is <em>ordering</em>: we recreate the <code>CancellationTokenSource</code> on line 5. The new source is <em>not</em> cancelled, which means that any new operations that happen after that line will evaluate <code>_resetMultiplexerCts.IsCancellationRequested</code> as false, even though we haven&rsquo;t actually created the new multiplexer (which happens on line 7).</p><p>Hence, we can get the following interleaving:</p><ul><li>Thread 1 triggers a reset by doing <code>_resetMultiplexerCts.Cancel()</code></li><li>Thread 2 starts an operation, takes the lock, runs up to line 5 inclusive</li><li>Thread 3 starts an operation, but sees the new <code>_resetMultiplexerCts</code>, skips the entire if statement in line 2, and takes a reference to the old multiplexer without actually using it</li><li>Thread 2 continues execution by closing the old connection multiplexer and creating the replacement</li><li>Thread 3 attempts to use the old multiplexer, triggering an <code>ObjectDisposedException</code></li></ul><p>Since we do A TON of Redis operations per second, the Thread 3 scenario would play out more frequently than you&rsquo;d expect. This was essentially fixed by doing this:</p><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>async</span> Task&lt;IDatabase&gt; GetDatabase(...) {
</span></span><span style=display:flex><span>  <span style=color:#719e07>if</span> (_resetMultiplexerCts.IsCancellationRequested) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>using</span> (<span style=color:#719e07>await</span> _mutex.WaitAsync()) {
</span></span><span style=display:flex><span>      <span style=color:#719e07>if</span> (_resetMultiplexerCts.IsCancellationRequested) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>await</span> CloseConnectionMultiplexer(_connectionMultiplexer);
</span></span><span style=display:flex><span>        <span style=color:#dc322f>var</span> newMultiplexer = <span style=color:#719e07>await</span> CreateConnectionMultiplexer();
</span></span><span style=display:flex><span>        Volatile.Write(<span style=color:#719e07>ref</span> _connectionMultiplexer, newMultiplexer);
</span></span><span style=display:flex><span>        _resetMultiplexerCts = <span style=color:#719e07>new</span> CancellationTokenSource();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>So essentially we avoid re-creating the <code>_resetMultiplexerCts</code> until we actually have a working instance. The memory barrier introduced by the <code>Volatile.Write</code> is meant to avoid <code>_resetMultiplexerCts</code>&rsquo;s assignment being reordered with the creation or assignment of the new multiplexer.</p><p>One could argue that this code is suboptimal in the sense that we wait for the old multiplexer to close instead of just creating a new one and doing the shutdown after we have unblocked all concurrent operations, but keep in mind this is a stateful third-party library we are dealing with, and we certainly didn&rsquo;t want to fall victims to &ldquo;oh we&rsquo;re caching some random thing underneath the hood, so BAZINGA!&rdquo; kind of bugs.</p></div><div class=content data-pagefind-ignore=all></div><button id=load-comments-button class="button is-primary is-active is-large is-fullwidth" style=display:none>Load Comments</button>
<script src=/js/comments.min.39e33edd67905b2b36477104baf1ec48ae8d66edab407617757a4adf0f6b75a0.js integrity="sha256-OeM+3WeQWys2R3EEuvHsSK6NZu2rQHYXdXpK3w9rdaA=" crossorigin=anonymous async defer></script></div></div></article></section><div class=top-button><a href=https://julian.bayardo.info/post/fun-bugs-part-1/#><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a></div><script src=/js/copycode.min.f9b11d6b28ddbf03b69f75a528e7d8768b374ae9336dcd284ebd1c764332fd6b.js integrity="sha256-+bEdayjdvwO2n3WlKOfYdos3Sukzbc0oTr0cdkMy/Ws=" crossorigin=anonymous async defer></script><script src=/js/toc-highlight.min.e7ab37b0afc209abb07ffa8102b73d478c9b74c36c80593bdccc9793fc60adb5.js integrity="sha256-56s3sK/CCauwf/qBArc9R4ybdMNsgFk73MyXk/xgrbU=" crossorigin=anonymous async defer></script><footer class=section style=padding-top:0><div class=container><hr><p style=float:left>&copy; Julian Bayardo Spadafora 2015-2024 | <a href=/privacy-policy/>Privacy Policy</a> | <a href=/terms-of-service/>Terms of Service</a></p><div style=float:right><a href=https://julian.bayardo.info/post/fun-bugs-part-1/#>Back to Top</a></div></div></footer></body></html>